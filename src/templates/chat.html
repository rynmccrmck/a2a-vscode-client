<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2A Agent Chat</title>
    <style>
        body { 
            font-family: var(--vscode-font-family); 
            color: var(--vscode-foreground); 
            background-color: var(--vscode-editor-background); 
            padding: 10px; 
            margin: 0; 
        }
        .container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            gap: 10px; 
        }
        .section { 
            border: 1px solid var(--vscode-widget-border); 
            border-radius: 4px; 
            padding: 10px; 
        }
        .status { 
            padding: 8px; 
            border-radius: 4px; 
            margin: 8px 0; 
            font-size: 12px; 
        }
        .status.success { 
            background-color: var(--vscode-testing-iconPassed); 
            color: white; 
        }
        .status.error { 
            background-color: var(--vscode-testing-iconFailed); 
            color: white; 
        }
        .chat-section { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        }
        .messages { 
            flex: 1; 
            overflow-y: auto; 
            margin-bottom: 10px; 
            padding: 8px; 
            background-color: var(--vscode-input-background); 
            border-radius: 4px; 
            min-height: 200px; 
        }
        .message { 
            margin-bottom: 10px; 
            padding: 6px 10px; 
            border-radius: 6px; 
            max-width: 90%; 
            word-wrap: break-word;
        }
        .message.user { 
            background-color: var(--vscode-button-background); 
            color: var(--vscode-button-foreground); 
            margin-left: auto; 
        }
        .message.agent { 
            background-color: var(--vscode-textCodeBlock-background); 
            border: 1px solid var(--vscode-widget-border); 
        }
        .message.agent.streaming {
            border-left: 3px solid var(--vscode-progressBar-background);
            animation: pulse 1s infinite;
        }
        .message.status {
            background-color: var(--vscode-notifications-background);
            border: 1px solid var(--vscode-notifications-border);
            font-size: 11px;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .message.status:hover {
            background-color: var(--vscode-list-hoverBackground);
        }
        .message.status .status-main {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .message.status .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .message.status .status-badge.submitted {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        .message.status .status-badge.working {
            background-color: var(--vscode-progressBar-background);
            color: white;
        }
        .message.status .status-badge.completed {
            background-color: var(--vscode-testing-iconPassed);
            color: white;
        }
        .message.status .status-badge.canceled {
            background-color: var(--vscode-testing-iconSkipped);
            color: white;
        }
        .message.status .status-badge.failed {
            background-color: var(--vscode-testing-iconFailed);
            color: white;
        }
        .message.status .status-badge.rejected {
            background-color: var(--vscode-testing-iconFailed);
            color: white;
        }
        .message.status .status-badge.auth-required {
            background-color: var(--vscode-testing-iconQueued);
            color: white;
        }
        .message.status .status-badge.unknown {
            background-color: var(--vscode-descriptionForeground);
            color: white;
        }
        .message.status .status-details {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid var(--vscode-widget-border);
            font-family: monospace;
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
            display: none;
        }
        .message.status.expanded .status-details {
            display: block;
        }
        .agent-info {
            margin-top: 8px;
            padding: 8px;
            background-color: var(--vscode-textCodeBlock-background);
            border-radius: 4px;
            border: 1px solid var(--vscode-widget-border);
            font-size: 11px;
            display: none;
        }
        .agent-info.visible {
            display: block;
        }
        .agent-info .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .agent-info .agent-header .agent-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .agent-info .agent-header .connected-check {
            color: var(--vscode-testing-iconPassed);
            font-size: 14px;
        }
        .agent-info .agent-content {
            transition: all 0.3s ease;
        }
        .agent-info.collapsed .agent-content {
            display: none;
        }
        .agent-info .agent-description {
            color: var(--vscode-descriptionForeground);
            margin-bottom: 8px;
            font-style: italic;
            line-height: 1.3;
        }
        .agent-capabilities {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }
        .capability-badge {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
        }
        .agent-skills {
            margin-top: 6px;
        }
        .skill-item {
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            padding: 4px 6px;
            margin: 2px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .skill-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }
        .skill-name {
            font-weight: bold;
            font-size: 10px;
        }
        .skill-description {
            color: var(--vscode-descriptionForeground);
            font-size: 9px;
            margin-top: 2px;
        }
        .skill-examples {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid var(--vscode-widget-border);
            display: none;
        }
        .skill-item.expanded .skill-examples {
            display: block;
        }
        .skill-example {
            background-color: var(--vscode-textCodeBlock-background);
            padding: 2px 4px;
            margin: 2px 0;
            border-radius: 2px;
            font-size: 8px;
            font-family: monospace;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .skill-example:hover {
            border-color: var(--vscode-button-background);
        }
        .toggle-info {
            font-size: 9px;
            color: var(--vscode-button-background);
            cursor: pointer;
            text-decoration: underline;
        }
        .message.system { 
            background-color: var(--vscode-badge-background); 
            color: var(--vscode-badge-foreground); 
            font-style: italic; 
            text-align: center; 
            font-size: 12px; 
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        input { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid var(--vscode-input-border); 
            border-radius: 4px; 
            background-color: var(--vscode-input-background); 
            color: var(--vscode-input-foreground); 
            margin: 5px 0; 
        }
        button { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 4px; 
            background-color: var(--vscode-button-background); 
            color: var(--vscode-button-foreground); 
            cursor: pointer; 
            margin: 2px; 
        }
        button:hover { 
            background-color: var(--vscode-button-hoverBackground); 
        }
        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .input-row { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        .input-row input { 
            flex: 1; 
            margin: 0; 
        }
        .session-info { 
            font-size: 11px; 
            color: var(--vscode-descriptionForeground); 
            margin-bottom: 8px; 
        }
        pre { 
            background-color: var(--vscode-textCodeBlock-background); 
            padding: 8px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 11px; 
            margin: 4px 0; 
        }
        /* Simple collapsible styles */
        .collapsible-details {
            margin-top: 4px;
            padding: 8px;
            background-color: var(--vscode-input-background);
            border-radius: 3px;
            border: 1px solid var(--vscode-widget-border);
            display: none;
            font-size: 10px;
            font-family: monospace;
            clear: both;
        }

        .collapsible-details.expanded {
            display: block;
        }

        .details-toggle {
            margin-left: 8px;
            font-size: 10px;
            color: var(--vscode-button-background);
            cursor: pointer;
            text-decoration: underline;
        }

        .details-toggle:hover {
            color: var(--vscode-button-hoverBackground);
        }

        .message.artifact {
            border-left: 3px solid var(--vscode-button-background);
            background-color: var(--vscode-textCodeBlock-background);
            position: relative;
        }

        .artifact-header {
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .artifact-status {
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
        }

        .artifact-name {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin: 4px 12px 8px 12px;
            font-style: italic;
        }

        .message.task-update {
            border-left: 3px solid var(--vscode-testing-iconPassed);
            background-color: var(--vscode-textCodeBlock-background);
            position: relative;
        }

        .message.status-detail {
            border-left: 3px solid var(--vscode-progressBar-background);
            background-color: var(--vscode-textCodeBlock-background);
            position: relative;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            transition: 0.2s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            top: 2px;
            background-color: var(--vscode-foreground);
            transition: 0.2s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--vscode-button-background);
            border-color: var(--vscode-button-background);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        .data-part {
            margin-top: 8px;
            border: 1px solid var(--vscode-widget-border);
            border-radius: 4px;
        }
        .data-header {
            padding: 6px 10px;
            background-color: var(--vscode-button-secondaryBackground);
            cursor: pointer;
            font-size: 12px;
        }
        .data-content pre {
            margin: 0;
            padding: 10px;
            font-size: 11px;
            background-color: var(--vscode-textCodeBlock-background);
        }
        .status-indicator {
            padding: 4px 8px;
            margin: 2px 0;
            background-color: var(--vscode-notifications-background);
            font-size: 11px;
            text-align: center;
            border-radius: 12px;
        }
        .status-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            background-color: var(--vscode-progressBar-background);
        }
        .status-indicator.with-text {
            padding: 8px 12px;
            background-color: var(--vscode-textCodeBlock-background);
            border-left: 3px solid var(--vscode-progressBar-background);
            margin: 4px 0;
        }

        .status-header {
            margin-bottom: 4px;
        }

        .status-text {
            font-size: 12px;
            line-height: 1.3;
        }
        .file-attachments {
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            background: var(--vscode-input-background);
            display: none;
        }

        .file-attachments.visible {
            display: block;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 3px;
            margin: 2px 0;
            background: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-widget-border);
        }

        .file-preview img {
            max-width: 32px;
            max-height: 32px;
            border-radius: 3px;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--vscode-button-secondaryBackground);
            border-radius: 3px;
            font-size: 14px;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
        }

        .file-remove {
            cursor: pointer;
            color: var(--vscode-errorForeground);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .file-remove:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .file-button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: pointer;
            margin-right: 4px;
        }

        .file-button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .message-files {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--vscode-widget-border);
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            margin: 2px 0;
            background: var(--vscode-textCodeBlock-background);
            border-radius: 3px;
            font-size: 11px;
        }

        /* Drop zone styles */
        .drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 123, 255, 0.1);
            border: 2px dashed var(--vscode-button-background);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 4px;
        }

        .drop-zone.visible {
            display: flex;
        }

        .drop-message {
            padding: 20px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Agent Connection Section -->
        <div class="section">
            <h3>Agent Connection</h3>
            <div class="input-row">
                <input type="text" id="agentUrl" placeholder="Agent URL" value="http://localhost:10000">
                <button onclick="checkAgent()" id="checkBtn">Check Agent</button>
            </div>
            <div id="agentStatus"></div>
            <div id="agentInfo" class="agent-info"></div>
        </div>
        
            <!-- Chat Section -->
        <div class="section chat-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>Chat</h3>
                </div>
                <div>
                    <button onclick="newTask()" id="newTaskBtn" disabled>New Task</button>
                </div>
            </div>
            <div class="session-info">
                <strong>Task ID:</strong> <span id="taskId">None</span>
            </div>
            
            <!-- Streaming Toggle -->
            <div style="margin: 5px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 12px;">Streaming:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="streamingToggle" checked onchange="toggleStreaming()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
                        
            <div class="messages" id="messages">
                <div class="message system">Enter an agent URL above and click "Check Agent" to start!</div>
            </div>
            
            <!-- File attachments area -->
            <div class="file-attachments" id="fileAttachments"></div>

            <!-- Input area with file support -->
            <div class="input-row">
                <input type="file" id="fileInput" multiple style="display: none;" accept="image/*,text/*,.pdf,.doc,.docx">
                <button onclick="selectFiles()" class="file-button" id="fileBtn" disabled title="Attach files">📎</button>
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <button onclick="sendMessage()" id="sendMessageBtn" disabled>Send</button>
            </div>

            <!-- Drop zone overlay -->
            <div class="drop-zone" id="dropZone">
                <div class="drop-message">Drop files here to attach</div>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let attachedFiles = [];
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        let agentConnected = false;
        let currentAgentUrl = '';
        let useStreaming = true;
        let messageSequence = 0;
        let currentTaskId = null;
        let currentContextId = null;

        function checkAgent() {
            const url = document.getElementById('agentUrl').value.trim();
            if (!url) return;
            
            currentAgentUrl = url;
            document.getElementById('checkBtn').disabled = true;
            showStatus('Checking agent...', null);
            
            vscode.postMessage({ type: 'checkAgent', url: url });
        }

        function addMessageWithFiles(text, files, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + sender;
            
            if (text) {
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                messageDiv.appendChild(textDiv);
            }
            
            if (files && files.length > 0) {
                const filesDiv = document.createElement('div');
                filesDiv.className = 'message-files';
                
                files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'message-file';
                    fileDiv.innerHTML = `
                        ${file.preview.startsWith('data:image/') 
                            ? `<img src="${file.preview}" alt="${file.name}">` 
                            : `<div class="file-icon">${file.preview}</div>`
                        }
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    `;
                    filesDiv.appendChild(fileDiv);
                });
                
                messageDiv.appendChild(filesDiv);
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && attachedFiles.length === 0) return;
            if (!agentConnected) return;
            
            // Display the message with files
            addMessageWithFiles(message, attachedFiles, 'user');
            
            input.value = '';
            const filesToSend = [...attachedFiles]; // Copy the array
            clearAttachedFiles(); // Clear UI
            disableSendButton();
            
            // Reset message tracking for new interaction
            messageSequence = 0;
            
            vscode.postMessage({ 
                type: 'sendMessage', 
                url: currentAgentUrl, 
                message: message,
                files: filesToSend, // Add files to the message
                useStreaming: useStreaming,
                taskId: currentTaskId,
                contextId: currentContextId
            });
        }

        function newTask() {
            currentTaskId = null;
            currentContextId = null;
            updateTaskDisplay();
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '<div class="message system">🆕 New task started - send a message to begin!</div>';
            
            addMessage('Task reset - ready for new conversation', 'system');
            
            // Re-enable send button
            enableSendButton();
        }

        function getTaskStatus() {
            if (!currentTaskId) {
                addMessage('No active task to check', 'system');
                return;
            }
            
            // Disable send button while checking status
            disableSendButton();
            
            vscode.postMessage({
                type: 'getTaskStatus',
                url: currentAgentUrl,
                taskId: currentTaskId
            });
        }

        function updateTaskDisplay() {
            console.log('Updating task display:', { taskId: currentTaskId });
            document.getElementById('taskId').textContent = currentTaskId || 'None';
        }

        function enableSendButton() {
            document.getElementById('sendMessageBtn').disabled = false;
        }

        function disableSendButton() {
            document.getElementById('sendMessageBtn').disabled = true;
        }

        function toggleStreaming() {
            const checkbox = document.getElementById('streamingToggle');
            useStreaming = checkbox.checked;
            console.log('Streaming mode:', useStreaming ? 'enabled' : 'disabled');
        }

        function showStatus(text, success) {
            const statusDiv = document.getElementById('agentStatus');
            
            if (success === false) {
                // Only show error status
                statusDiv.textContent = text;
                statusDiv.className = 'status error';
            } else {
                // Hide status for success (shown in agent info instead)
                statusDiv.textContent = '';
                statusDiv.className = '';
            }
        }

        function addMessage(text, sender, streaming = false, data = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + sender + (streaming ? ' streaming' : '');
            
            if (sender === 'agent' && typeof text === 'object') {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(text, null, 2);
                messageDiv.appendChild(pre);
            } else {
                messageDiv.textContent = text;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        function addStatusMessage(data) {
            // Only show status without message content for pure status updates
            if (data.statusOnly) {
                const messagesDiv = document.getElementById('messages');
                const statusDiv = document.createElement('div');
                statusDiv.className = 'message status';
                
                const mainDiv = document.createElement('div');
                mainDiv.className = 'status-main';
                
                const badge = document.createElement('span');
                badge.className = `status-badge ${data.status.state}`;
                badge.textContent = data.status.state.toUpperCase().replace('-', '-');
                mainDiv.appendChild(badge);
                
                if (data.status.final) {
                    const finalSpan = document.createElement('span');
                    finalSpan.textContent = '✓ Final';
                    finalSpan.style.color = 'var(--vscode-testing-iconPassed)';
                    finalSpan.style.fontSize = '10px';
                    mainDiv.appendChild(finalSpan);
                }
                
                statusDiv.appendChild(mainDiv);
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'status-details';
                detailsDiv.innerHTML = `
                    <div>Task ID: ${data.status.taskId}</div>
                    <div>Context ID: ${data.status.contextId}</div>
                    <div>Timestamp: ${new Date(data.status.timestamp).toLocaleTimeString()}</div>
                `;
                statusDiv.appendChild(detailsDiv);
                
                statusDiv.addEventListener('click', () => {
                    statusDiv.classList.toggle('expanded');
                });
                
                messagesDiv.appendChild(statusDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function addMessageWithParts(text, dataParts = []) {
            const messageDiv = addMessage(text || '', 'agent');
            
            // Add collapsible data parts
            dataParts.forEach((dataPart, index) => {
                const dataContainer = document.createElement('div');
                dataContainer.className = 'data-part';
                dataContainer.innerHTML = `
                    <div class="data-header" onclick="toggleDataPart(this)">
                        Data Part ${dataPart.name || index + 1} ▼
                    </div>
                    <div class="data-content" style="display: none;">
                        <pre>${JSON.stringify(dataPart.data, null, 2)}</pre>
                    </div>
                `;
                messageDiv.appendChild(dataContainer);
            });
        }

        function toggleDataPart(header) {
            const content = header.nextElementSibling;
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            header.textContent = header.textContent.replace(isHidden ? '▼' : '▲', isHidden ? '▲' : '▼');
        }

        function processStreamingData(data) {
            messageSequence++;
            
            // Update task info from streaming data if we don't have it yet
            if (data.taskId && !currentTaskId) {
                currentTaskId = data.taskId;
                updateTaskDisplay();
                console.log('Updated taskId from stream:', currentTaskId);
            }
            if (data.contextId && !currentContextId) {
                currentContextId = data.contextId;
            }
            
            // Handle different event types
            switch (data.type) {
                case 'status-update':
                    handleStatusUpdate(data);
                    break;
                case 'artifact-update':
                    handleArtifactUpdate(data);
                    break;
                case 'task-update':
                    handleTaskUpdate(data);
                    break;
                case 'message-parts':
                    addMessageWithParts(data.text, data.dataParts);
                    break;
                default:
                    // Fallback for old format
                    handleLegacyFormat(data);
            }
        }

        function addStatusIndicator(state, statusInfo = {}) {
            const messagesDiv = document.getElementById('messages');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-indicator';
            statusDiv.innerHTML = `<span class="status-badge ${state}">${state.toUpperCase()}</span> Task ${state}`;
            messagesDiv.appendChild(statusDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function selectFiles() {
            document.getElementById('fileInput').click();
        }

        function setupFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const chatSection = document.querySelector('.chat-section');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop
            chatSection.addEventListener('dragover', handleDragOver);
            chatSection.addEventListener('dragleave', handleDragLeave);
            chatSection.addEventListener('drop', handleDrop);
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
            event.target.value = ''; // Reset input
        }

        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.add('visible');
        }

        function handleDragLeave(event) {
            if (!event.relatedTarget || !event.currentTarget.contains(event.relatedTarget)) {
                document.getElementById('dropZone').classList.remove('visible');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.remove('visible');
            
            const files = Array.from(event.dataTransfer.files);
            processFiles(files);
        }

        async function processFiles(files) {
            for (const file of files) {
                if (file.size > MAX_FILE_SIZE) {
                    addMessage(`File "${file.name}" is too large (max 10MB)`, 'system');
                    continue;
                }
                
                try {
                    const fileData = await readFileAsBase64(file);
                    const preview = await generatePreview(file);
                    
                    attachedFiles.push({
                        name: file.name,
                        mimeType: file.type || 'application/octet-stream',
                        size: file.size,
                        data: fileData,
                        preview: preview
                    });
                } catch (error) {
                    addMessage(`Failed to process file "${file.name}": ${error.message}`, 'system');
                }
            }
            updateFileDisplay();
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1]; // Remove data:mime;base64, prefix
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function generatePreview(file) {
            if (file.type.startsWith('image/')) {
                return await createImagePreview(file);
            } else {
                return createFileIcon(file);
            }
        }

        function createImagePreview(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function createFileIcon(file) {
            const extension = file.name.split('.').pop()?.toLowerCase() || '';
            const icons = {
                'pdf': '📄',
                'doc': '📝', 'docx': '📝',
                'txt': '📄',
                'json': '📋',
                'csv': '📊',
                'default': '📎'
            };
            return icons[extension] || icons.default;
        }

        function updateFileDisplay() {
            const container = document.getElementById('fileAttachments');
            
            if (attachedFiles.length === 0) {
                container.classList.remove('visible');
                return;
            }
            
            container.classList.add('visible');
            container.innerHTML = attachedFiles.map((file, index) => `
                <div class="file-preview">
                    ${file.preview.startsWith('data:image/') 
                        ? `<img src="${file.preview}" alt="${file.name}">` 
                        : `<div class="file-icon">${file.preview}</div>`
                    }
                    <div class="file-info">
                        <div class="file-name" title="${file.name}">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-remove" onclick="removeFile(${index})" title="Remove file">×</div>
                </div>
            `).join('');
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            updateFileDisplay();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function clearAttachedFiles() {
            attachedFiles = [];
            updateFileDisplay();
        }

        function handleStatusUpdate(data) {
            if (data.statusOnly) {
                addStatusIndicator(data.status.state, data.status);
            } else if (data.text && data.text.trim()) {
                addStatusIndicatorWithText(data.status.state, data.text, data.status);
            }
        }

        function addStatusIndicatorWithText(state, text, statusInfo = {}) {
            const messagesDiv = document.getElementById('messages');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-indicator with-text';
            statusDiv.innerHTML = `
                <div class="status-header">
                    <span class="status-badge ${state}">${state.toUpperCase()}</span>
                </div>
                <div class="status-text">${text}</div>
            `;
            messagesDiv.appendChild(statusDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleArtifactUpdate(data) {
            console.log('Artifact update received:', data);
            
            let artifactDiv = document.getElementById(`artifact-${data.artifactId}`);
            
            if (!artifactDiv) {
                // Create new artifact message
                artifactDiv = document.createElement('div');
                artifactDiv.id = `artifact-${data.artifactId}`;
                artifactDiv.className = 'message artifact';
                
                // Add header with icon and type
                const header = document.createElement('div');
                header.className = 'artifact-header';
                header.innerHTML = `
                    <span>📎 Artifact</span>
                    <span class="artifact-status">${data.lastChunk ? '✓ Complete' : '⏳ In Progress'}</span>
                `;
                artifactDiv.appendChild(header);
                
                // Add artifact name as subtitle
                const nameDiv = document.createElement('div');
                nameDiv.className = 'artifact-name';
                nameDiv.textContent = data.name;
                artifactDiv.appendChild(nameDiv);
                
                // Add content area
                const content = document.createElement('div');
                content.id = `artifact-content-${data.artifactId}`;
                artifactDiv.appendChild(content);
                
                document.getElementById('messages').appendChild(artifactDiv);
            }
            
            // Update content
            updateArtifactContent(artifactDiv, data);
            
            // Update status
            const statusSpan = artifactDiv.querySelector('.artifact-status');
            if (statusSpan) {
                statusSpan.textContent = data.lastChunk ? '✓ Complete' : '⏳ In Progress';
            }
            
            scrollToBottom();
        }
        function handleTaskUpdate(data) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'message task-update';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'artifact-header';
            header.innerHTML = `
                <span>🎯 Task Update</span>
                <span class="artifact-status">${data.state}</span>
            `;
            taskDiv.appendChild(header);
            
            // Add content
            const content = document.createElement('div');
            content.textContent = `Task ${data.taskId.substring(0, 8)}... changed to ${data.state}`;
            taskDiv.appendChild(content);
            
            // Add details toggle
            addDetailsToggle(taskDiv, {
                'Task ID': data.taskId,
                'Context ID': data.contextId,
                'State': data.state,
                'Timestamp': new Date(data.timestamp).toLocaleString()
            }, 'Task Details');
            
            document.getElementById('messages').appendChild(taskDiv);
            scrollToBottom();
        }

        function handleLegacyFormat(data) {
            // Keep existing behavior for backward compatibility
            if (data.statusOnly) {
                addStatusMessage(data);
            } else if (data.text && data.text.trim()) {
                addMessage(data.text, 'agent');
            }
        }

        function updateArtifactContent(artifactDiv, data) {
            const contentDiv = artifactDiv.querySelector(`#artifact-content-${data.artifactId.replace('artifact-', '')}`);
            
            if (data.append) {
                // Append to existing content
                if (data.textContent) {
                    const textSpan = document.createElement('span');
                    textSpan.textContent = data.textContent;
                    contentDiv.appendChild(textSpan);
                }
            } else {
                // Replace content
                if (data.textContent) {
                    contentDiv.textContent = data.textContent;
                }
            }
            
            // Add details toggle for data content
            if (data.dataContent && Object.keys(data.dataContent).length > 0) {
                addDetailsToggle(artifactDiv, data.dataContent, 'Data');
            }
        }

        function addDetailsToggle(parentElement, detailsData, label = 'Details') {
            // Check if toggle already exists
            if (parentElement.querySelector('.details-toggle')) {
                return;
            }
            
            // Create a wrapper for the toggle that goes on same line as text
            const toggleSpan = document.createElement('span');
            toggleSpan.className = 'details-toggle';
            toggleSpan.textContent = `▼ ${label}`;
            toggleSpan.onclick = () => toggleDetails(parentElement, toggleSpan);
            
            // Create details div that will appear on next line
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'collapsible-details';
            
            if (typeof detailsData === 'object') {
                detailsDiv.innerHTML = `<pre>${JSON.stringify(detailsData, null, 2)}</pre>`;
            } else {
                detailsDiv.textContent = detailsData;
            }
            
            // Add toggle to the end of the text content
            parentElement.appendChild(toggleSpan);
            // Add details div as a separate block below
            parentElement.appendChild(detailsDiv);
        }

        function toggleDetails(parentElement, toggleSpan) {
            const details = parentElement.querySelector('.collapsible-details');
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                toggleSpan.textContent = toggleSpan.textContent.replace('▲', '▼');
            } else {
                details.classList.add('expanded');
                toggleSpan.textContent = toggleSpan.textContent.replace('▼', '▲');
            }
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showAgentInfo(agentCard) {
            const agentInfoDiv = document.getElementById('agentInfo');
            
            // Create capabilities badges
            const capabilities = [];
            if (agentCard.capabilities?.streaming) capabilities.push('Streaming');
            if (agentCard.capabilities?.pushNotifications) capabilities.push('Push Notifications');
            
            const capabilityBadges = capabilities.map(cap => 
                `<span class="capability-badge">${cap}</span>`
            ).join('');
            
            // Create skills list
            const skillsHtml = agentCard.skills?.map(skill => `
                <div class="skill-item" onclick="toggleSkill(this)">
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-description">${skill.description}</div>
                    <div class="skill-examples">
                        ${skill.examples?.map(example => 
                            `<div class="skill-example" onclick="useExample('${example.replace(/'/g, "\\'")}'); event.stopPropagation();">${example}</div>`
                        ).join('') || ''}
                    </div>
                </div>
            `).join('') || '<div style="color: var(--vscode-descriptionForeground);">No skills defined</div>';
            
            agentInfoDiv.innerHTML = `
                <div class="agent-header">
                    <div class="agent-name">
                        <span>${agentCard.name} v${agentCard.version}</span>
                        <span class="connected-check">✓</span>
                    </div>
                    <span class="toggle-info" onclick="toggleAgentInfo()">Show Details</span>
                </div>
                <div class="agent-content">
                    <div class="agent-description">${agentCard.description || 'No description provided'}</div>
                    <div class="agent-capabilities">${capabilityBadges}</div>
                    <div class="agent-skills">
                        <strong>Skills (click to expand):</strong>
                        ${skillsHtml}
                    </div>
                </div>
            `;
            
            agentInfoDiv.classList.add('visible', 'collapsed');
        }

        function toggleAgentInfo() {
            const agentInfoDiv = document.getElementById('agentInfo');
            const toggleText = agentInfoDiv.querySelector('.toggle-info');
            
            if (agentInfoDiv.classList.contains('collapsed')) {
                agentInfoDiv.classList.remove('collapsed');
                toggleText.textContent = 'Hide Details';
            } else {
                agentInfoDiv.classList.add('collapsed');
                toggleText.textContent = 'Show Details';
            }
        }

        function toggleSkill(skillElement) {
            skillElement.classList.toggle('expanded');
        }

        function useExample(example) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = example;
            messageInput.focus();
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message:', message);
            
            switch (message.type) {
                case 'taskInfo':
                    currentTaskId = message.taskId;
                    currentContextId = message.contextId;
                    updateTaskDisplay();
                    break;

                case 'agentChecked':
                    document.getElementById('checkBtn').disabled = false;
                    
                    if (message.success) {
                        agentConnected = true;
                        const agent = message.agent;
                        showStatus('', true); // Clear any error status
                        showAgentInfo(agent);
                        document.getElementById('messageInput').disabled = false;
                        document.getElementById('sendMessageBtn').disabled = false;
                        document.getElementById('newTaskBtn').disabled = false;
                        document.getElementById('fileBtn').disabled = false;
                        updateTaskDisplay();
                        // No longer adding "Connected to agent" message - shown in agent header
                    } else {
                        agentConnected = false;
                        showStatus('Connection failed: ' + message.error, false);
                        document.getElementById('agentInfo').classList.remove('visible');
                        document.getElementById('messageInput').disabled = true;
                        document.getElementById('sendMessageBtn').disabled = true;
                        document.getElementById('newTaskBtn').disabled = true;
                        document.getElementById('fileBtn').disabled = true;
                    }
                    break;

                case 'taskCreated':
                    currentTaskId = message.taskId;
                    currentContextId = message.contextId;
                    updateTaskDisplay();
                    addMessage(`🎯 Task created: ${message.taskId}`, 'system');
                    break;
                    
                case 'messageResponse':
                    if (message.streaming) {
                        console.log('Streaming chunk received:', message.data);
                        
                        // Filter out raw JSON data that shouldn't be displayed
                        if (message.data.raw || message.data.error) {
                            console.log('Skipping raw/error data:', message.data);
                            break;
                        }
                        
                        processStreamingData(message.data);
                        
                        // Check if this is the final streaming message
                        if (message.data.status?.final) {
                            console.log('Final streaming message detected - enabling send button');
                            enableSendButton();
                        }
                        break;
                    }

                    // Normal response after stream or single-shot
                    console.log('Non-streaming response received - enabling send button');
                    enableSendButton();
                    
                    if (message.success) {
                        // Handle task creation from response
                        if (message.data?.result?.id && message.data?.result?.kind === 'task') {
                            currentTaskId = message.data.result.id;
                            currentContextId = message.data.result.contextId;
                            updateTaskDisplay();
                            addMessage(`🎯 Task created: ${currentTaskId}`, 'system');
                        }
                        
                        // Also check streaming data for task info updates
                        if (message.data?.status?.taskId) {
                            if (message.data.status.taskId !== currentTaskId) {
                                currentTaskId = message.data.status.taskId;
                                updateTaskDisplay();
                                console.log('Updated taskId from non-streaming response:', currentTaskId);
                            }
                            // Track contextId internally but don't display
                            if (message.data.status.contextId) {
                                currentContextId = message.data.status.contextId;
                            }
                        }
                        
                        const result = message.data.result || message.data;
                        let responseText = '';
                        
                        if (result?.parts) {
                            result.parts.forEach(part => {
                                if (part.kind === 'text') {
                                    responseText += part.text;
                                }
                            });
                        } else if (result?.message?.parts) {
                            result.message.parts.forEach(part => {
                                if (part.kind === 'text') {
                                    responseText += part.text;
                                }
                            });
                        } else if (typeof result === 'string') {
                            responseText = result;
                        } else if (result?.kind !== 'task') {
                            responseText = JSON.stringify(result, null, 2);
                        }
                        
                        if (!message.streaming && responseText) {
                            addMessage(responseText || 'Empty response', 'agent');
                        }
                    } else {
                        addMessage('Error: ' + message.error, 'system');
                    }
                    break;

                case 'streamComplete':
                    console.log('Stream completed - re-enabling send button');
                    enableSendButton();
                    addMessage('🔄 Stream completed', 'system');
                    break;

                case 'error':
                    addMessage('Extension Error: ' + message.error, 'system');
                    enableSendButton();
                    break;
            }
        });
    setupFileHandling();
    </script>
</body>
</html>